---
title: "ã‚¤ãƒ³ãƒ•ãƒ©åˆå¿ƒè€…ãŒAWSã§WordPressæ§‹ç¯‰ã—ã¦ã¿ãŸã‚‰æ‰‹ã“ãšã£ãŸä»¶ï¼ˆRoute53 ALB EC2 docker nginx Mysqlï¼‰"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "docker", "wordpress", "nginx"]
published: true
---

![AWSæ§‹æˆå›³](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_Route53_ALB_EC2.webp)

æ™®æ®µã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®äººã§ã™ã€‚
ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€ã‚¤ãƒ³ãƒ•ãƒ©ã•ã‚“ãŒ
æ§‹ç¯‰ã—ã¦ãã‚ŒãŸç’°å¢ƒãƒ»æ‰‹é †ã‚’ãƒãƒã‚‹ã ã‘ã€‚

EC2ãªã‚‰ãã“ã¾ã§é›£ã—ããªã„ã¨èã„ã¦ã€
å‹‰å¼·ãŒã¦ã‚‰ã€AWSã‚’ã‚¤ãƒã‹ã‚‰æ§‹ç¯‰ã—ã¦ã¿ãŸã‚‰

ã‚¤ãƒ³ãƒ•ãƒ©çŸ¥è­˜ã»ã¼ã‚¼ãƒ­ã®ã¼ãã«ã¯
**ã‚„ã£ã±ã‚Šå¼·æ•µã§ã—ãŸ**ã€ã¨ã„ã†è©±ã§ã™ã€‚

ã‚ã¾ã‚Šã‚„ã‚‰ãªã„ä½œæ¥­ãªã®ã§
å¿˜å‚™éŒ²ã‚’å…¼ã­ã¦è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚


# â‘ AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

æœ€åˆã«å¥‘ç´„ã™ã‚‹äººã¯
ç´„ï¼‘å¹´ã®ç„¡æ–™æœŸé–“ãŒã¤ãã¯ãšã§ã™ã€‚
ã¼ãã¯ä»¥å‰å¥‘ç´„ã—ã¦ã„ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã—ãŸã€‚

rootã«è¨­å®šã—ã¦ã„ãŸMFAã‚‚æºå¸¯é›»è©±ã‚‚
æ©Ÿç¨®å¤‰ã«ã¦ãƒ­ã‚¹ãƒˆã—ã¦ã„ãŸãŸã‚
ã“ã“ã§ã‘ã£ã“ã†ãƒˆãƒ©ãƒ–ã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸãŒã€
æœ¬è¨˜äº‹ã§ã¯å‰²æ„›ã€‚IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã£ãŸã®ã§
ãªã‚“ã¨ã‹ãªã‚Šã¾ã—ãŸã€‚

# â‘¡EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‹



### â‘¡-1ã€€AMIã‚’é¸ã¶

AMIã¨ã¯ã€OSã¨ã‹ã‚µãƒ¼ãƒãƒ¼ã¨ã‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‹ã€
ãã†ã„ã†ã‚‚ã®ãŒã‚ˆã—ãªã«ã‚‚ã‚ã‚‚ã‚ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒƒã‚¯ã§
ã¾ã¨ã¾ã£ã¦ã„ã‚‹ã€Œãƒ‡ã‚£ã‚¹ã‚¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã¿ãŸã„ãªãƒ¢ãƒã§ã™ã€‚

Linuxã¨WordPressï¼ˆã¨ãã‚ŒãŒå‹•ããŸã‚ã«å¿…è¦ãªãƒ¢ãƒå…¨éƒ¨ï¼‰
ãŒã¾ã¨ã¾ã£ã¦ã„ã‚‹Bitnamiã¨å‘¼ã°ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚
ã‚ã‚‹ã‚ˆã†ã§ã™ãŒã€ä»Šå›ã¯æ™®é€šã«OSé¸æŠã‹ã‚‰ã„ãã¾ã™ã€‚

OSã¯ç„¡é›£ãã†ãªã€
Amazon Linux 2 AMIï¼ˆHVMï¼‰Kernel 5.10ã‚’é¸ã‚“ã§ã€
ã€ŒAMIã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã€ã‚’é¸æŠ

### â‘¡-2ã€€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’é¸ã¶

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã¯ä»®æƒ³ãƒã‚·ãƒ³ã®ã“ã¨ã§ã™ã€‚
ã‚¿ã‚¤ãƒ—ã¨ã¯ã€ã‚¹ãƒšãƒƒã‚¯ï¼ˆã¨ãƒ¬ãƒ³ã‚¿ãƒ«æ–™é‡‘ï¼‰ã‚’
ã“ã“ã§é¸ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚

ç„¡æ–™æ æ®‹ã£ã¦ã‚‹äººã¯ã€
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã€Œt2.microã€ã§ã„ã„ã¨æ€ã„ã¾ã™ã€‚

ã¼ãã¯ç„¡æ–™æ åˆ‡ã‚Œã¦ãŸã®ã§ã€
æœ€å®‰ã®ã€Œt2.nanoã€ã‚’é¸æŠã—ã¦ã¿ã¾ã—ãŸã€‚

![EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—é¸æŠ](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_EC2_type.webp)


æœ‰æ–™ãªã‚‰ã€mç³»ã¨ã‹ã®ãŒç„¡é›£ã‚‰ã—ã„ã§ã™ãŒã€
ãŸã„ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚‚ãªã„è¶£å‘³ãƒ¦ãƒ¼ã‚¹ãªã®ã§OKã§ã™ã€‚

AWSç®¡ç†ç”»é¢ã‹ã‚‰ã„ã¤ã§ã‚‚ã‚«ãƒ³ã‚¿ãƒ³ã«
å¢—å¼·ï¼ˆã‚¹ãƒšãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ã§ãã‚‹ã‚‰ã—ã„ã®ãŒã€
ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®ã„ã„ã¨ã“ã‚ãªã®ã§
ã“ã“ã¯æ°—è»½ã«é¸ã‚“ã§ã—ã¾ã£ã¦OKã§ã™ã€‚

### â‘¡-3ã€€ã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œæˆ

ä½œã£ã¦ãªã‹ã£ãŸã‚‰ã“ã“ã§ã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œã£ã¦ãŠãã¾ã—ã‚‡ã†

![ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_EC2_Keypair.webp)

â‘¢ä»¥é™ã®ç’°å¢ƒæ§‹ç¯‰ã§å®Ÿéš›ã«
EC2ã«SSHæ¥ç¶šã™ã‚‹ã¨ãã«ä½¿ã„ã¾ã™ã€‚

### â‘¡-4ã€€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ

ä½œã£ã¦ãªã‹ã£ãŸã‚‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚‚ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚
0.0.0.0ï¼ˆã©ã“ã‹ã‚‰ã§ã‚‚ï¼‰ã§æ¥ç¶šå¯èƒ½ã«ã™ã‚‹ã«ã¯
éæ¨å¥¨ã¨ã§ã¦ã„ã‚‹ã®ã§
è‡ªåˆ†ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®æ¥ç¶šã®ã¿ã‚’è¨±å¯ã—ã¾ã™ã€‚

ã‚‚ã‚ã‚‚ã‚è¨­å®šã—ãŸã‚ã¨ã€ã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã€ã‚’æŠ¼ã—ã¦
æˆåŠŸã™ã‚Œã°OKã§ã™ï¼

### â‘¡-5 ElasticIPã‚’è¨­å®šã™ã‚‹

IPã‚’å›ºå®šã™ã‚‹å ´åˆã¯å¿…è¦ã§ã™ã€‚
ã¼ãã¯é »ç¹ã«SSHå…¥ã‚‹ã®ã§
EC2ã®IPå¤‰ã‚ã‚‹ã¨é¢å€’ã ã£ãŸã®ã§è¨­å®šã—ã¾ã—ãŸã€‚



# â‘¢ã¿ã‚“ãªå¤§å¥½ãLinuxç’°å¢ƒæ§‹ç¯‰

ç›´ã«PHPã‚„MySQLã€WordPressã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€
Dockerã‚’ä½¿ã†ã¨ç’°å¢ƒã®æ•´å‚™ãŒæœ¬æ ¼çš„ã«ã§ãã¾ã™ã€‚

## â‘¢-1ã€€EC2ã«ã€€sshæ¥ç¶š
ã€ŒEC2ã€€>ã€€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€€>ã€€ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDï¼‰ã€€>ã€€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶šã€
ã§ã¤ãªãæ–¹ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

## â‘¢-2ã€€ã‚‚ã‚ã‚‚ã‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å‚è€ƒã«ã—ãŸè¨˜äº‹ï¼š
https://qiita.com/HyunwookPark/items/92d10899cd19f2f06f91

```sh
sudo yum update -y
```
40ç§’ãã‚‰ã„å¾…ã¤

### dockerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```sh
sudo amazon-linux-extras install docker -y
```
15ç§’ãã‚‰ã„å¾…ã¤

```sh
sudo systemctl start docker
sudo systemctl status docker
sudo usermod -a -G docker ec2-user
```

### docker-composeã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

#ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
docker-compose --version
```

ã“ã®ã‚ã¨ã€docker-compose.ymlã‚’ç·¨é›†
æœ€çµ‚çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```yml:docker-compose.yml
# æ§‹æˆ: mysql5.7 + wordpress + php7.3-fpm + nginx

version: '3'
services:

  # mysql
  db:
    image: mysql:5.7
    environment:
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      TZ: 'Asia/Tokyo'
    restart: always
    volumes:
      - ./docker/mysql:/var/lib/mysql
    ports:
      - "3306:3306"
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci


  # wordpress+php
  wordpress:
    image: wordpress:php7.3-fpm
    environment:
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    volumes:
      - ./wordpress:/var/www/html
      - ./docker/php/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
    depends_on:
      - db
    restart: always

  # nginx
  nginx:
    image: nginx:stable
    ports:
      - '${NGINX_PORT}:80'
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/nginx/log:/var/log/nginx
      - ./wordpress:/var/www/html
    depends_on:
      - wordpress
    restart: always


```
docker-compose.ymlã¯
.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã‚Œã¾ã™ã€‚
`${MYSQL_USER}`ã¨ã‹ã¯
.envã«è¨­å®šã—ã¾ã™ã€‚

.envã¯ä»¥ä¸‹ã‚’å‚è€ƒã«è¨­å®šã€‚

```sh:.env.sample
# mysql
MYSQL_ROOT_PASSWORD=password
MYSQL_USER=root
MYSQL_PASSWORD=password
MYSQL_DATABASE=wordpress

# wordpress
DB_HOST=mysql
DB_USER=root
DB_PASSWORD=password
DB_NAME=wordpress

# nginx
NGINX_PORT=80
```


### æº–å‚™ã§ããŸã‚‰docker-composeã‚’èµ·å‹•

```sh
docker-compose up --build -d
```
1åˆ†ãã‚‰ã„ã€‚
docker-compose.ymlã¨
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§
nginxã€mysqlã€wordpressãŒ


```sh
sudo yum install git
```
10ç§’æœªæº€

https://ï¼ˆEC2ã®IPï¼‰/

ã§ã€WordPressã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”»é¢ãŒå‡ºãŸã‚‰æˆåŠŸã§ã™ï¼

ãã®ç”»é¢ã‹ã‚‰WordPressã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯
ãƒ‰ãƒ¡ã‚¤ãƒ³â†’EC2ã¾ã§ç–é€šã—ã¦ã‹ã‚‰ã€
ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰è¡Œã†ã®ãŒã„ã„ã§ã™ã€‚

# â‘£ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’AWSã§å–å¾—ã™ã‚‹

åˆ¥ã«ãŠåå‰.comç­‰ã§ã¨ã£ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’EC2ç³»ã«
å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€
ã¼ãçš„ã«ã¯ã¾ã¨ã¾ã£ã¦è«‹æ±‚ããŸã»ã†ãŒ
ã‚ˆã‹ã£ãŸã®ã§å…¨éƒ¨AWSã§æ¸ˆã¾ã›ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

## â‘£-1 Route 53ã«ã‚¢ã‚¯ã‚»ã‚¹

ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç™»éŒ²ã§ãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œç´¢ã€OKãªã‚‰ç™»éŒ²
ã€€ç¶šè¡Œ

ãƒ»é€£çµ¡å…ˆãªã©ã‚’ã„ã‚Œã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã«ã„ã‚Œã‚‹

ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ç™»éŒ²å®Œäº†ã€15åˆ†ãã‚‰ã„å¾…ã¤

![Route53 ç™»éŒ²å®Œäº†](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_Route53_Regist.webp)

## â‘£-2 ãã®é–“ã«ALBï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µï¼‰ã‚’ä½œã‚‹

~~ä»Šå›ã¯EC2ã€€1å°æ§‹æˆãªã®ã§å¿…è¦ãªã„ã£ã¡ã‚ƒå¿…è¦ãªã„~~ãŒã€
ï¼ˆACMï¼ˆAmazonã®ç„¡æ–™SSLè¨¼æ˜æ›¸ï¼‰ã«ã¯
ã€€ALBä½¿ã†ã®ãŒæ‰‹è»½ã‹ã¤æ¨å¥¨ï¼ˆâ†“ï¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§æ„å‘³ã¯ã‚ã‚Šã¾ã™ï¼‰

https://aws.amazon.com/jp/premiumsupport/knowledge-center/configure-acm-certificates-ec2/

ALBè‡ªä½“ãŒEC2ã®æ ¼å®‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚ˆã‚Šã‚‚ãŠå€¤æ®µå¼µã‚Šã¾ã™ãŒã€
å‹‰å¼·ã®ãŸã‚ã«å°å…¥ã—ã¾ã—ãŸã€‚
Application Load Blanceré¸æŠ

![ALBé¸æŠ](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_ALB.webp)

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
ACMã«SSLè¨¼æ˜æ›¸ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
ãƒ‘ãƒ–ãƒªãƒƒã‚¯è¨¼æ˜æ›¸ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

### ãƒ‰ãƒ¡ã‚¤ãƒ³â†’ALBã®å‰²å½“

Route53ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é¸ã‚“ã§ã€Œãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã®ä½œæˆã€ãƒœã‚¿ãƒ³

### ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä½œæˆ

ãƒ»ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æœ‰åŠ¹ã«ã—ã¦å…ˆã»ã©ä½œæˆã—ãŸALBã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’é¸æŠã™ã‚‹ã ã‘ã€‚ã‚«ãƒ³ã‚¿ãƒ³

![Route53 Aãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¨­å®š](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_Route53_A_Record.webp)


ãƒ»ãŠåå‰.comãªã©ã®å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å‰²å½“ã‚’ã™ã‚‹ãªã‚‰ã“ã“ã‚‰ã¸ã‚“ã‚’å‚è€ƒã«

https://nishinatoshiharu.com/ec2-with-alb-dns-setting/

### ALBâ†’tgï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‰

EC2ã‚’2ã¤ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ï¼ˆè² è·åˆ†æ•£ï¼‰ã™ã‚‹ã¨ã‹
è¨­å®šã§ãã‚‹ã‚“ã ã‘ã©ã€ä»Šå›ã¯ï¼‘ã¤ã®EC2ã‚’
tgã«è¨­å®šã—ã¾ã—ãŸã€‚

### ALBã®URLã§EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèªã™ã‚‹

ç„¡äº‹ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸã€‚
ã‚ã¨ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³â†’ALBã‚’ç–é€šã•ã›ãŸã‚ã¨ã€
SSLè¨¼æ˜æ›¸ã‚’å°å…¥ã™ã‚‹ã ã‘ã§ã™ã€‚

## â‘£-3 AWS Certificate Manager

ACMè¨¼æ˜æ›¸ã¯AWSã§ä½œã‚Œã‚‹ç„¡æ–™ã®SSLè¨¼æ˜æ›¸ã§ã™ã€‚

AWS Certificate Managerã‚’é¸æŠ
ã€Œè¨¼æ˜æ›¸ã€â†’ã€Œè¨¼æ˜æ›¸ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€
â†’ã€Œãƒ‘ãƒ–ãƒªãƒƒã‚¯è¨¼æ˜æ›¸ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€

ã§ã€ã‚ã£ã•ã‚Šä½œã‚Œã¾ã™ã€‚

![ACMç™»éŒ²ç”»é¢](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_ACM.webp)

### Cãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®š

ACMç™»éŒ²ç”»é¢ã®ã¨ã“ã‚ã§ã€ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆãƒœã‚¿ãƒ³ã§
ã‚µã‚¯ãƒƒã¨ä½œã‚Œã¾ã™ã€‚

### httpsã¨httpã€€ä¸¡æ–¹ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆã«ã€å¼·åˆ¶httpsåŒ–ã™ã‚‹

ALBã§80ãƒªã‚¹ãƒŠãƒ¼ã‚’443ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šã§ãã¾ã™ã€‚
ã“ã‚Œã ã‘ã§httpã‚¢ã‚¯ã‚»ã‚¹ã—ãŸäººã¯
httpsã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚ä¾¿åˆ©â™ª



## â‘¤ WordPressã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

æœ€åˆã«è¨­å®šã™ã‚‹ãƒ›ã‚¹ãƒˆåãŒã‚ã‹ã‚‰ãšã€
ã ã„ã¶ã¦ã“ãšã‚Šã¾ã—ãŸã€‚

![WordPressã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ãƒ›ã‚¹ãƒˆå](https://kugyu10-post.s3.ap-northeast-1.amazonaws.com/2022/09/AWS_wordpress_install.webp)

ã“ã‚Œã¯docker-compose.ymlã«ã‚ã‚‹
db:

ã®`db`ãŒæ­£è§£ã§ã—ãŸã€‚
ã“ã‚“ãªã‚“ã‚ã‹ã‚‹ã‹ï¼

å¼·åˆ¶httpsã«ã—ã¦ãŠã‹ãªã„ã¨ã€mixinå•é¡ŒãŒ
èµ·ãã‚‹ã®ã§ã€è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

```php:wp-config.php
/*  å¼·åˆ¶HTTPSåŒ–  */
define( 'WP_HOME', 'https://è‡ªåˆ†ã®WPã®URL' );
define( 'WP_SITEURL', 'https://è‡ªåˆ†ã®WPã®URL' );

define('FORCE_SSL_ADMIN', true);
if ( ! empty( $_SERVER['HTTP_X_FORWARDED_PROTO'] )
     && $_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https' )
{
    $_SERVER['HTTPS']='on';
}
```

wp-config.phpã¯æ›¸ãçµ‚ã‚ã£ãŸã‚‰
ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³600ã¨ã‹ã«ã—ã¨ã„ãŸæ–¹ãŒã„ã„ã§ã™ã€‚
DBæ¥ç¶šæƒ…å ±ãŒã‚ã‚‹ã®ã§ã€‚

ã‚ã¨uploadsã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’757ã«ã—ã¨ã‹ãªã„ã¨
ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¨ãƒ©ãƒ¼ã§ã¾ã™ã€‚

# mysqlãŒãªã‚“ã‹è‰¯ãè½ã¡ã‚‹ã‚“ã ã‘ã©

å‚è€ƒã«ãªã£ãŸè¨˜äº‹
https://codelab.website/ec2-mysql/

ã¾ãŸã€è­¦å‘Šã©ãŠã‚Šã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’600ã«ã—ã¨ã

sudo chmod 600 /swapfile

ã‚ã¨EC2å†èµ·å‹•æ™‚ã«è‡ªå‹•ã§dockerèµ·å‹•ã™ã‚‹è¨­å®šã‚’å…¥ã‚Œã¦ãŠã

https://qiita.com/horikeso/items/2ea0f262deefed56eed3


# æ„Ÿæƒ³

AWSã‚¹ã‚­ãƒ«ç„¡ã—ã€
ã‚¤ãƒ³ãƒ•ãƒ©çŸ¥è­˜ã‚‚ã‚ã‚“ã¾ã‚Šãªã„çŠ¶æ…‹ã§
èª¿ã¹èª¿ã¹ã§æ‰‹æ¢ã‚Šã§ã‚„ã£ãŸã‚‰
ãƒˆãƒ¼ã‚¿ãƒ«ã§ï¼“æ—¥ä»¥ä¸Šã‹ã‹ã‚Šã¾ã—ãŸ

docker-compose.yml
ãŒçŸ­ã„è¨˜è¿°ãªã®ã«ã„ã‚ã„ã‚
ã§ãã™ãã¦ä¾¿åˆ©ã™ãã¾ã™ã€‚

Route53â†’ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³â†’ALBâ†’tgâ†’EC2

ã¨ã„ã†ã¤ãªãæ–¹ãŒæ…£ã‚Œãšã€
EC2ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰è©¦è¡ŒéŒ¯èª¤ã‚‚éå¸¸ã«è‹¦åŠ´ã—ã¾ã—ãŸã€‚



ã§ã‚‚ã€ã“ã‚Œã§ã€ã¼ããŒå¯ã¦ã„ã‚‹é–“ã‚‚
ç¨¼åƒã—ã¦ãã‚Œã‚‹ï¼ˆä»®æƒ³ï¼‰ã‚µãƒ¼ãƒãƒ¼ãŒ
ã“ã®ä¸–ã«èª•ç”Ÿã—ãŸã¨æ€ã†ã¨ã€ã¡ã‚‡ã£ã¨æ„Ÿæ…¨æ·±ã„ã§ã™ã€‚

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ»ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æŠ€è¡“ã«æ„Ÿè¬ã€‚
ã‚¤ãƒ³ãƒ•ãƒ©asCodeã®æŠ€è¡“ã‚‚ã€ã¼ãã¿ãŸã„ãª
ã‚¤ãƒ³ãƒ•ãƒ©ãƒŸãƒªçŸ¥ã‚‰å‹¢ã«ã¯è´…æ²¢ã™ãã‚‹æŠ€è¡“ã«æ„Ÿè¬ã€‚

ã—ã‹ã—ã€

# ã“ã‚Œã§ã‚ã§ãŸã—ã‚ã§ãŸã—ã€ã§ã¯ãªã‹ã£ãŸ

AWSå‹‰å¼·ã®å¿…è¦æ€§ã‚’ç—›æ„Ÿã€‚
Xã‚µãƒ¼ãƒãƒ¼ã®ã‚ˆã†ã«ã€
è¼‰ã›ã¨ã„ã¦ã€ã‚ã¨ã¯æ”¾ç½®ã€ã¨ã„ã†ã‚ã‘ã«ã¯
ã„ãã¾ã›ã‚“ã€‚

æœ¬ç•ªç’°å¢ƒãªã‚‰ç›£è¦–ãƒ„ãƒ¼ãƒ«ã‚„ã€
å†èµ·å‹•ã™ã‚‹è¨­å®šãªã©ã‚‚ã—ãªã„ã¨ã ã—ãƒ»ãƒ»ãƒ»

WordPressåˆæœŸè¨­å®šã‚‚ã‚„ã‚‹ã“ã¨å¤šã„ã§ã™ã€‚

ãƒ»GTM
ãƒ»GA4
ãƒ»SearchConsole
ãƒ»SEOã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ†ãƒ¼ãƒãƒ»ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®é¸å®š
ãƒ»å­ãƒ†ãƒ¼ãƒã®ä½œæˆã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š

ãªã©ã€ã“ã®ã‚ã¨ã‚‚ã‚„ã‚‹ã“ã¨ã¯å¤šã„ã§ã™ã€

ã‚ã¨ã¯è¶£å‘³ãƒ¦ãƒ¼ã‚¹ã®å‰²ã«ã¯æ–™é‡‘ãŒé«˜ã„ã®ã§
å¤–éƒ¨CAã‚’ä½¿ã†ã¨ã‹ã—ã¦å®‰ã„æ–¹æ³•è€ƒãˆãŸã„ã§ã™ã€‚

# ä½•ã‚ˆã‚Šä¸€ç•ªå¤§å¤‰ãªã®ãŒ

WordPressé‹ç”¨ã€ã¤ã¾ã‚Š

ã€Œæ¯æ—¥ãƒ–ãƒ­ã‚°æ›¸ãã€

ã¨ã„ã†ã“ã¨ï¼ï¼

ãŒã€ãŒã‚“ã°ã‚Šã¾ã™ï¼ˆéœ‡ãˆå£°ï¼‰


# è¿½è¨˜ï¼šLet's Encrypt å°å…¥ã—ã¾ã—ãŸ

å††å®‰ã‚‚ã‚ã£ã¦ALBç¶­æŒè²»é«˜ã‹ã£ãŸã®ã§
Let's Encryptã‚’å°å…¥ã—ã¦ã¿ã¾ã—ãŸã€‚

## å°å…¥æ™‚å‚è€ƒã«ã—ãŸè¨˜äº‹

https://blog.panicblanket.com/archives/6759

https://paulownia.hatenablog.com/entry/2020/09/12/150658

https://qiita.com/ax_kazz/items/f837e237e968db3d3ab3

https://qiita.com/s-katsumata/items/629222b24113d7a49b79

## certbotã‚³ãƒãƒ³ãƒ‰æ™‚ã®ã‚¨ãƒ©ãƒ¼

# ã€Œ/user/share/nginx/html does not exist or is not a directoryã€

ã„ã‚„ã„ã‚„ã€rootã¯ `/var/www/html`ã«ã—ãŸã„ã¨
è¨€ã£ã¦ã„ã‚‹ã®ã«ã€ã€ã€

ã—ã‚‡ã†ãŒãªã„ã®ã§docker-composeã«volumesã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

# ã€ŒIf you specify multiple webroot paths, one of them must precede all domain flagsã€

ã„ã‚„ã„ã‚„ã€webrootä¸€å€‹ã—ã‹æŒ‡å®šã—ã¦ã¾ã›ã‚“ãŒãªã€‚
ã„ã‚ã„ã‚è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ã‚„ã£ãŸã¨ã“ã‚ã€

`--entrypoint ''` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã†ã¾ãã„ã£ãŸæ¨¡æ§˜



## æœ€çµ‚çš„ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

certbotã‚³ãƒãƒ³ãƒ‰æˆåŠŸã•ã›ã¦ã€
ç„¡äº‹è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¥æ‰‹ã§ããŸã‚ã¨ã®
æœ€çµ‚çš„ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¢ã£ã¦ãŠãã¾ã™ã€‚

```sh:nginx/conf.d/default.conf

server {
  listen 80;
  server_name _;

  # redirect https
  location / {
    return 301 https://$host$request_uri;
  }

  #accept from let's encrypt request
  location /.well-known/acme-challenge/ {
    root /var/www/html;
  }

  # root /var/www/html;
  # try_files $uri $uri/ /index.php?$args;
  # index  index.php index.index;
}

server {
  listen 443 ssl;
  server_name _;

  root /var/www/html;

  ssl_certificate      /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem;
  ssl_certificate_key  /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem;
  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:10m;
  ssl_session_tickets off;

  ssl_protocols TLSv1.3 TLSv1.2;
  ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256';
  ssl_trusted_certificate  /etc/letsencrypt/live/YOUR_DOMAIN/chain.pem;
  add_header Strict-Transport-Security "max-age=2592000" always;
  ssl_prefer_server_ciphers on;
  #ssl_stapling on;
  #ssl_stapling_verify on;
  #resolver 8.8.8.8 8.8.4.4 valid=300s;
  #resolver_timeout 5s;

  client_max_body_size 1024M;

  index  index.php index.html;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  location ~ \.php$ {
    try_files $uri =404;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass wordpress:9000;
    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
  }
}
                                                  
```


```yml:docker-compose.yml
# æ§‹æˆ: mysql5.7 + wordpress + php7.3-fpm + nginx + certbot

version: '3'
services:

  # mysql
  db:
    image: mysql:5.7
    environment:
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      TZ: 'Asia/Tokyo'
    restart: always
    volumes:
      - ./docker/mysql:/var/lib/mysql
    ports:
      - "3306:3306"
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci


  # wordpress+php.3-fpm
  wordpress:
    image: wordpress:php7.3-fpm
    environment:
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    volumes:
      - ./wordpress:/var/www/html
      - ./docker/php/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
          depends_on:
      - db
    restart: always

  # nginx
  nginx:
    image: nginx:stable
    ports:
      - '${NGINX_PORT}:80'
      - '${NGINX_S_PORT}:443' # certbotã‚³ãƒãƒ³ãƒ‰å¾Œè¿½åŠ 
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/nginx/log:/var/log/nginx
      - ./wordpress:/var/www/html
      - /etc/letsencrypt:/etc/letsencrypt
      - /var/lib/letsencrypt:/var/lib/letsencrypt
      - ./public:/user/share/nginx/html/
    depends_on:
      - wordpress
    restart: always

  # ã“ã“ã‚’è¿½åŠ 
  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./wordpress:/var/www/html
      - /etc/letsencrypt:/etc/letsencrypt
      - /var/lib/letsencrypt:/var/lib/letsencrypt
      - ./public:/user/share/nginx/html/
    depends_on:
      - nginx
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    restart: always
```

ã‚¤ãƒ³ãƒ•ãƒ©åˆ†ã‹ã£ã¦ãªã„ã®ã§ç„¡é§„ãªè¨˜è¿°ã‚‚å¤šã„ã¨æ€ã†ã‘ã©
è¨˜éŒ²ã¨ã—ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚

ï¼ˆALBã¯å‰Šé™¤ã—ãªã„ã¨èª²é‡‘ãŒç¶šãã‚ˆã†ãªã®ã§å‰Šé™¤ã—ã¾ã™ï¼‰

kugyu10
